# What files to copy or adapt for each task?
## 1. Create MQTT Inspector

## 2. Register Inspectors

## 3. Parse Publish Messages

## 4. Publish Topic/Events

```
Byte Layout of PUBLISH Packet:
════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────┐
│ FIXED HEADER (2-5 bytes)                                        │
├─────────────────────────────────────────────────────────────────┤
│ Byte 0: Control Packet Type + Flags                             │
│   Bits 7-4: Packet Type = 0011 (3 = PUBLISH)                    │
│   Bit 3:    DUP flag (duplicate delivery)                       │
│   Bits 2-1: QoS level (00=0, 01=1, 10=2)   ← We extract this!   │
│   Bit 0:    RETAIN flag                                         │
├─────────────────────────────────────────────────────────────────┤
│ Byte 1-4: Remaining Length (variable length encoding)           │
│   1-4 bytes depending on packet size                            │
│   Bit 7 (0x80): Continuation bit (1=more bytes follow)          │
│   Bits 6-0 (0x7F): Length value                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ VARIABLE HEADER (variable length)                               │
├─────────────────────────────────────────────────────────────────┤
│ Bytes N, N+1: Topic Length (2 bytes, big-endian)                │
│   MSB first, then LSB                                           │
│   Example: 0x00 0x0B = 11 bytes                                 │
├─────────────────────────────────────────────────────────────────┤
│ Bytes N+2 to N+2+TopicLen-1: Topic String (UTF-8)               │
│   Example: "temperature" (11 bytes)                             │
│   ↑↑↑ get_buf_mqtt_topic() extracts THIS                        │
├─────────────────────────────────────────────────────────────────┤
│ Bytes (optional): Packet Identifier (2 bytes)                   │
│   ONLY present if QoS > 0                                       │
│   MSB, LSB (big-endian)                                         │
│   Used for QoS 1 (PUBACK) and QoS 2 (PUBREC/PUBREL/PUBCOMP)     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ PAYLOAD (remaining bytes)                                       │
├─────────────────────────────────────────────────────────────────┤
│ Bytes: Application Message (any binary data)                    │
│   Example: "72.5" or JSON: {"temp":72.5,"unit":"F"}             │
│   ↑↑↑ get_buf_mqtt_payload() extracts THIS                      │
│   Length = (Remaining Length) - (Variable Header Length)        │
└─────────────────────────────────────────────────────────────────┘
```
```
Raw bytes in memory (p->data):

Offset  Bytes       Field                    Parsing
──────────────────────────────────────────────────────────────────
0x00    0x32        Fixed Header Byte 1      
                    ════════════════════
                    Binary: 0011 0010
                            ││││ │││└─ RETAIN = 0
                            ││││ ││└── QoS bit 0 = 1
                            ││││ │└─── QoS bit 1 = 0  → QoS = 1
                            ││││ └──── DUP = 0
                            └┴┴┴────── Type = 3 (PUBLISH)

0x01    0x15        Remaining Length         = 21 bytes
                    (bit 7 = 0, so only 1 byte for length)

        ════════════ Variable Header Starts ════════════

0x02    0x00        Topic Length MSB         0x00
0x03    0x0C        Topic Length LSB         0x0C
                    Combined: 0x000C = 12 bytes

0x04-0x0F           Topic String             "sensors/temp"
        s e n s o r s / t e m p

0x10    0x00        Packet ID MSB            0x00
0x11    0x01        Packet ID LSB            0x01
                    Combined: 0x0001 = packet ID 1
                    (Present because QoS = 1)

        ════════════ Payload Starts ════════════

0x12-0x15           Payload                  "72.5"
        7 2 . 5

Total packet: 22 bytes (0x00 to 0x15)
```
```
Packet bytes:  0x32  0x15  0x00  0x0C  's'   'e'   'n'   's'   'o'   'r'
Index:         [0]   [1]   [2]   [3]   [4]   [5]   [6]   [7]   [8]   [9]
               ↑     ↑     ↑     ↑     ↑─────────────────────────────↑
               │     │     │     │     Topic string starts here
               │     │     │     │
               │     │     │     Topic length LSB (0x0C = 12)
               │     │     Topic length MSB (0x00)
               │     Remaining length (0x15 = 21 bytes)
               Fixed header byte 1 (0x32)
```
```
Wireshark says:
- Header Flags: 0x30
- Msg Len: 18
- Topic Length: 12
- Topic: sensors/temp
- Message: 37322e35 (hex = "72.5")

┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ 0x30 │ 0x12 │ 0x00 │ 0x0C │  s   │  e   │  n   │  s   │  o   │  r   │
│ [0]  │ [1]  │ [2]  │ [3]  │ [4]  │ [5]  │ [6]  │ [7]  │ [8]  │ [9]  │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
   │      │      │      │      └──────────────────────────────────────
   │      │      │      │      "sensors/temp" starts here
   │      │      │      Topic length LSB = 12
   │      │      Topic length MSB = 0
   │      Remaining length = 18
   Header: Type=3, QoS=0

┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│  s   │  /   │  t   │  e   │  m   │  p   │ 0x37 │ 0x32 │ 0x2e │ 0x35 │
│ [10] │ [11] │ [12] │ [13] │ [14] │ [15] │ [16] │ [17] │ [18] │ [19] │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
                                    └──────────────────────────────────
                                    Payload: "72.5" (ASCII)
                                    0x37='7', 0x32='2', 0x2e='.', 0x35='5'

Total: 20 bytes ✓ (matches "TCP payload (20 bytes)")
```
```
Wireshark says:
- Header Flags: 0x10 (Type=1 CONNECT)
- Msg Len: 32
- Protocol Name: MQTT (4 bytes)
- Version: 4
- Connect Flags: 0xc2
- Keep Alive: 60
- Client ID Length: 0 (EMPTY!)
- User Name: testuser
- Password: Kurdewar

Byte layout:
┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ 0x10 │ 0x20 │ 0x00 │ 0x04 │  M   │  Q   │  T   │  T   │ 0x04 │ 0xc2 │
│ [0]  │ [1]  │ [2]  │ [3]  │ [4]  │ [5]  │ [6]  │ [7]  │ [8]  │ [9]  │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
   │      │      └────────┴──────────────────────────────┘      │      │
   │      │      Protocol Name Len=4, Name="MQTT"               │      │
   │      Remaining length = 32                              Version  Flags
   Header: Type=1 (CONNECT)

┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ 0x00 │ 0x3c │ 0x00 │ 0x00 │ 0x00 │ 0x08 │  t   │  e   │  s   │  t   │
│ [10] │ [11] │ [12] │ [13] │ [14] │ [15] │ [16] │ [17] │ [18] │ [19] │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
 └────┴────┘   └────┴────┘   └────┴────┘   └────────────────────────────
 Keep Alive    Client ID     Username Len   Username starts
 = 60          Length = 0!   = 8            "testuser"
               (EMPTY)

┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│  u   │  s   │  e   │  r   │ 0x00 │ 0x08 │  K   │  u   │  r   │  d   │
│ [20] │ [21] │ [22] │ [23] │ [24] │ [25] │ [26] │ [27] │ [28] │ [29] │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
                              └────┴────┘
                              Password Len = 8

┌──────┬──────┬──────┬──────┐
│  e   │  w   │  a   │  r   │
│ [30] │ [31] │ [32] │ [33] │
└──────┴──────┴──────┴──────┘

Total: 34 bytes ✓ (matches "TCP payload (34 bytes)")
```
```
┌────────────────────────────────────────────────────────────────────────┐
│                           Snort3 Core                                  │
│                                                                        │
│   ┌─────────────────┐                                                  │
│   │ Network Traffic │                                                  │
│   └────────┬────────┘                                                  │
│            │                                                           │
│            v                                                           │
│   ┌─────────────────┐     ┌──────────────────┐                         │
│   │ TCP Stream      │────>│ MqttSplitter     │  (mqtt_paf.cc)          │
│   │ Reassembly      │     │ Finds message    │                         │
│   └─────────────────┘     │ boundaries       │                         │
│                           └────────┬─────────┘                         │
│                                    │                                   │
│                                    v                                   │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    Mqtt::eval()  (mqtt.cc)                      │  │
│   │                                                                 │  │
│   │  1. Get/create MqttFlowData                                     │  │
│   │  2. Parse packet type from first byte                           │  │
│   │  3. If PUBLISH: extract topic + payload, publish event          │  │
│   │  4. If CONNECT: extract client_id, publish event                │  │
│   │                                                                 │  │
│   └──────────────────┬──────────────────────────────────────────────┘  │
│                      │                                                 │
│          ┌───────────┴───────────┐                                     │
│          │                       │                                     │
│          v                       v                                     │
│   ┌──────────────┐       ┌──────────────┐                              │
│   │ IPS Rules    │       │ DataBus      │                              │
│   │              │       │ Events       │                              │
│   │ mqtt_topic;  │       │              │                              │
│   │ content:"x"; │       │ Other plugins│                              │
│   │              │       │ can subscribe│                              │
│   └──────────────┘       └──────────────┘                              │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```


> Every MQTT field that can vary in size is preceded by a length. The parser never “looks for” fields. It only trusts lengths and flags.


````
Byte Layout of CONNECT Packet
════════════════════════════════════════════════════════════════════

Offset  Bytes       Field                          Parsing
────────────────────────────────────────────────────────────────────
0x00    0x10        Fixed Header Byte 1
                    ════════════════════
                    Binary: 0001 0000
                            └┴┴┴────── Type = 1 (CONNECT)
                            flags must be 0000 for CONNECT

0x01    0x20        Remaining Length = 32 bytes
                    (bit 7 = 0 → length encoded in 1 byte)

        ════════════ Variable Header Starts ════════════

0x02    0x00        Protocol Name Length MSB
0x03    0x04        Protocol Name Length LSB
                    Combined: 0x0004 = 4 bytes

0x04-0x07           Protocol Name               "MQTT"
        M Q T T

0x08    0x04        Protocol Level
                    0x04 = MQTT v3.1.1

0x09    0xC2        Connect Flags
                    Binary: 1100 0010
                            ││││ │││└─ Reserved = 0
                            ││││ ││└── Clean Session = 1
                            ││││ │└─── Will Flag = 0
                            ││││ └──── Will QoS = 0
                            │││└────── Will Retain = 0
                            ││└─────── Password Flag = 1
                            │└──────── User Name Flag = 1

0x0A    0x00        Keep Alive MSB
0x0B    0x3C        Keep Alive LSB
                    Combined: 0x003C = 60 seconds

        ════════════ Payload Starts ════════════

0x0C    0x00        Client ID Length MSB
0x0D    0x00        Client ID Length LSB
                    Combined: 0x0000 = 0 bytes
                    (Client ID is empty – allowed with Clean Session)

        ─────────── Client ID (absent) ───────────

0x0E    0x00        Username Length MSB
0x0F    0x08        Username Length LSB
                    Combined: 0x0008 = 8 bytes

0x10-0x17           Username                    "testuser"
        t e s t u s e r

0x18    0x00        Password Length MSB
0x19    0x08        Password Length LSB
                    Combined: 0x0008 = 8 bytes

0x1A-0x21           Password                    "Kurdewar"
        K u r d e w a r

Total packet: 34 bytes (0x00 to 0x21)
````

#### TCP treats data as a continuous stream of bytes. But application protocols have messages with boundaries. PAF's job is to find where one message ends and the next begins, so Snort can analyze complete messages:
```
MQTT PAF Design
════════════════════════════════════════════════════════════════════

                    ┌─────────────────────────────────────┐
                    │                                     │
                    v                                     │
            ┌───────────────────┐                         │
  START ───>│   FIXED_HEADER    │ Read 1 byte             │
            │   (Packet Type)   │                         │
            └─────────┬─────────┘                         │
                      │                                   │
                      v                                   │
            ┌───────────────────┐                         │
            │  REMAINING_LEN    │<──────┐                 │
            │                   │       │                 │
            │  Read 1 byte      │       │                 │
            │  Check bit 7      │       │                 │
            └─────────┬─────────┘       │                 │
                      │                 │                 │
          ┌───────────┼─────────────────┘                 │
          │           │                                   │
   bit 7=1│    bit 7=0│                                   │
   (more) │    (done) │                                   │
          │           v                                   │
          │   ┌───────────────────┐                       │
          │   │ length == 0?      │                       │
          │   └───────┬───────────┘                       │
          │           │                                   │
          │     YES   │   NO                              │
          │     ┌─────┴─────┐                             │
          │     │           │                             │
          │     │           v                             │
          │     │   ┌───────────────────┐                 │
          │     │   │     PAYLOAD       │                 │
          │     │   │   Read N bytes    │                 │
          │     │   └─────────┬─────────┘                 │
          │     │             │                           │
          │     │             │ (got all N bytes)         │
          │     v             v                           │
          │   ┌───────────────────┐                       │
          │   │    SET_FLUSH      │───────────────────────┘
          │   │  Flush message    │     (reset to start)
          │   └───────────────────┘
          │
          └──> (read next length byte, loop in REMAINING_LEN)
```
`x << n = x × 2ⁿ`